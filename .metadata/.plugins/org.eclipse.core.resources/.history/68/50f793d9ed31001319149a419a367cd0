/***********************************************
 	The Tabla Guy Visuals
 	by Varun Vachhar (Oct 2013)
 	http://lambdafunction.ca
 	
 	Copyright (c) 2013 Varun Vachhar
 	All rights reserved
 ***********************************************/

import java.util.ArrayList;

import netP5.*;
import processing.core.*;
import themidibus.*;
import oscP5.*;

@SuppressWarnings("serial")
public class MainApp extends PApplet {
	 
    MidiBus myBus;
    OscP5 oscP5;
    NetAddress myRemoteLocation;
    
    Note[] notes = new Note [128];
    float amplitude;
    Class<?> activeSongType;
    int trackToMonitor;
    boolean useSustain;
    ArrayList<Object> songs;
    PyramidScene song;
    // Visuals
    
    
    //**********************************************************
    // SETUP
    //**********************************************************
    public void setup() {
        size(1000, 700, OPENGL);
        smooth(6);
        rectMode(CENTER);
        noStroke();
        
        // Setup Midi Listener
        MidiBus.list();
        myBus = new MidiBus(this, 0, 0);
        
        // Setup liveOSC
        oscP5 = new OscP5(this, 9001);
        myRemoteLocation = new NetAddress("localhost", 9000);
        oscP5.plug(this, "meters", "/live/track/meter");
        
        // Build Note Handlers
        for (int i = 0; i < notes.length; i++) {
			notes[i] = new Note(this);
		}
        
        // Define and build the various Songs
        songs = new ArrayList<Object>();
        
        songs.add(new PyramidScene(this,
        		"Flying Pyramids",
        		notes,
				new int[] { 67, 63, 62, 60, 56, 55, 51, 50, 48, 44, 43, 39, 38, 36 },
				1));
        
        // Choose initial track to monitor
        activeSongType = PyramidScene.class;
        setScene(activeSongType);
    } 
    
    
    //**********************************************************
    // DRAW
    //**********************************************************
    public void draw() {
    	background(255);
    	// Update all Midi Notes
	    for (int i = 0; i < notes.length; i++) {
	    	notes[i].update();
		}
	    lights();
	    
	    for (Object obj: list) {
	        if (obj instanceof String){
	        	song.draw();
	        } else if (obj instanceof Integer) {
	        	song.draw();
	        } else if (obj instanceof Long) {
	        	song.draw();
	        }
	    }
	    
	    // Display frame rate
	    frame.setTitle("Tabla Visuals | " + song.name + " | " + (int)frameRate + " fps"); 
    }
    
    
    public Object setScene(Class<?> type) {
    	for (Object obj: list) {
    		if(obj instanceof type) song = obj;
    	}
    	song = songs.get(activeSong);
    	song = (activeSongType)songs.get(activeSong);
        trackToMonitor = song.t;
    }
    
    
    //**********************************************************
    // Handle MIDI Calls
    //**********************************************************
    public void noteOn(int channel, int pitch, int velocity) {
    	// println("note on: "+pitch +" "+ velocity);
    	notes[pitch].on();
	}

    public void noteOff(int channel, int pitch, int velocity) {
    	// println("note off: "+pitch +" "+ velocity);
		notes[pitch].off();
	}
    
    
    //**********************************************************
    // Handle OSC Calls
    //**********************************************************
//    public void oscEvent(OscMessage theOscMessage) {
//    	println("addrpattern: "+theOscMessage.addrPattern());
//	}
    
    public void meters(int track, int channel, float value) {
    	if (track == trackToMonitor) {
    		amplitude = value;
    	}
//    	 println("track: "+track+" channel: "+ channel+" value: "+value);
    }
    
    
    //**********************************************************
    // Input Handlers
    //**********************************************************
    public void keyPressed() {
    	if (key == 's' || key =='S') {
    		useSustain = !useSustain;
    	}
    }
    
    
    //**********************************************************
    // MAIN
    //**********************************************************
    public static void main(String args[]) {
    	PApplet.main(new String[] { /*"--present",*/ "MainApp" });
    }
}







